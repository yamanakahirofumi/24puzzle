# 実装詳細

本ドキュメントでは、開発時に注意すべき特定のアルゴリズムや実装方針の詳細を定義します。

## 1. シャッフルと解の保証 (Solvability)
スライドパズルにおいて、ランダムにパネルを配置すると、半分以上の確率で「解けないパズル」になります。これを回避するため、以下のいずれかの手法を採用します。

### 1.1 推奨手法：ランダムウォーク法
完成した状態からスタートし、空きマスに隣接するパネルをランダムに動かす処理を十分な回数（例：200回以上）繰り返します。
- **メリット**: 必ず解けることが数学的に保証されます。
- **注意点**: 手数表示やタイマーは、シャッフル完了後にリセットして開始する必要があります。

### 1.2 置換のパリティによる判定
パネルをランダムに並べた後、その状態が解けるかどうかを判定し、解けない場合は配置をやり直すか、特定のパネルを入れ替えて調整します。

#### 5×5 盤面（奇数幅）での判定ルール
盤面の幅が奇数（$W=5$）の場合、解の到達可能性は非常にシンプルです。
- **判定基準**: 空きマスを除いたパネルの並びの**転倒数 (Inversion Count)** の偶奇を確認します。
- **解ける条件**: 転倒数が**偶数**であること（ゴール状態が転倒数 0 の偶置換であるため）。

> **転倒数とは**: あるパネルのペア $(a, b)$ において、$a > b$ かつ $a$ が $b$ より前に配置されている組の数です。

## 2. 画像処理 (Image Processing)
ユーザーが読み込んだ画像をパズルとして使用するための手順です。

### 2.1 クロップとスケーリング
1. 読み込んだ画像のアスペクト比を確認します。
2. 中央を基準に、正方形になるようにクロップ（切り抜き）します。
3. 5×5 のグリッドに分割しやすいサイズ（例：500x500 や 1000x1000）にリサイズします。

### 2.2 分割
JavaFX の `PixelReader` と `WritableImage` を使用して、25個の断片に分割します。
- 右下のパネル（25番目）は「空きマス」として扱うため、描画しないか透明にします。

## 3. ロギング方針
デバッグおよび保守のため、適切なロギングを行います。

- **使用ライブラリ**: `java.util.logging` (標準)
- **ログレベル**:
    - `INFO`: ゲーム開始、画像読み込み成功、パズル完成などの主要イベント。
    - `WARNING`: サポート外の画像形式の読み込み試行、不適切な操作。
    - `SEVERE`: 予期せぬ実行時エラー、リソース読み込み失敗。

## 4. エラーハンドリング
- **ファイル IO**: 画像ファイルが存在しない、または読み取り権限がない場合の例外処理。
- **メモリ管理**: 高解像度の画像を大量に読み込んだ際のメモリ不足（OutOfMemoryError）への配慮（適切なリサイズと不要なオブジェクトの破棄）。
