# 実装詳細

本ドキュメントでは、開発時に注意すべき特定のアルゴリズムや実装方針の詳細を定義します。

## 1. シャッフルと解の保証 (Solvability)
スライドパズルにおいて、ランダムにパネルを配置すると、半分以上の確率で「解けないパズル」になります。これを回避するため、本プロジェクトでは以下の**ランダムウォーク法**を採用します。

### 1.1 採用手法：ランダムウォーク法
完成した状態からスタートし、空きマスに隣接するパネルをランダムに動かす処理を十分な回数（例：200回以上）繰り返します。
- **メリット**: 必ず解けることが数学的に保証されます。
- **仕様との整合性**: 「完成状態からシャッフルを開始する」という機能仕様を直接的に実現する手法です。
- **注意点**: 手数表示やタイマーは、シャッフル完了後にリセットして開始する必要があります。

### 1.2 補足：置換のパリティによる判定
パネルをランダムに並べた後、その状態が解けるかどうかを判定し、解けない場合は配置をやり直すか、特定のパネルを入れ替えて調整します。

#### 5×5 盤面（奇数幅）での判定ルール
盤面の幅が奇数（$W=5$）の場合、解の到達可能性は非常にシンプルです。
- **判定基準**: 空きマスを除いたパネルの並びの**転倒数 (Inversion Count)** の偶奇を確認します。
- **解ける条件**: 転倒数が**偶数**であること（ゴール状態が転倒数 0 の偶置換であるため）。

> **転倒数とは**: あるパネルのペア $(a, b)$ において、$a > b$ かつ $a$ が $b$ より前に配置されている組の数です。

## 2. 画像処理 (Image Processing)
ユーザーが読み込んだ画像をパズルとして使用するための手順です。

### 2.1 クロップとスケーリング
1. 読み込んだ画像のアスペクト比を確認します。
2. 中央を基準に、正方形になるようにクロップ（切り抜き）します。
    - 元のサイズを $W, H$ とすると、切り出し開始位置 $(x, y)$ とサイズ $S$ は以下の通り計算します。
    - $W > H$ の場合: $x = (W - H) / 2, y = 0, S = H$
    - $H > W$ の場合: $x = 0, y = (H - W) / 2, S = W$
    - $W = H$ の場合: $x = 0, y = 0, S = W$
3. 5×5 のグリッドに分割しやすいサイズ（例：500x500 や 1000x1000）にリサイズします。

### 2.2 分割
JavaFX の `PixelReader` と `WritableImage` を使用して、25個の断片に分割します。
- 右下のパネル（25番目）は「空きマス」として扱うため、描画しないか透明にします。

### 2.3 数字のオーバーレイ表示
画像パズルにおいて、タイル上に数字を重畳表示する際の実装指針です。
- **レイヤー構造**: JavaFX の `StackPane` を使用し、下層に `ImageView`（分割された画像）、上層に `Label` または `Text`（数字）を配置します。
- **スタイリング (CSS)**: 数字の視認性を高めるため、外部 CSS ファイルで以下のスタイルを定義します。
    - `-fx-fill` または `-fx-text-fill`: 白（または高コントラスト色）
    - `-fx-effect`: `dropshadow` を使用して、黒色の縁取りや影を付与します。
- **表示制御**: `StackPane` 内の数字用ノードの `visibleProperty` を、コントロールパネルのチェックボックスの状態にバインドすることで、動的な表示切り替えを実現します。

### 2.4 タイルの視覚的フィードバック
ユーザーが「どのパネルが動かせるか」を直感的に理解できるよう、CSS を使用してフィードバックを提供します。
- **実装方法**: 移動可能なパネルに対してのみ、コード上で `.movable-tile` スタイルクラスを付与します。
- **CSS 例**:
```css
/* 移動可能なパネルにマウスを乗せた時の効果 */
.movable-tile:hover {
    -fx-effect: dropshadow(three-pass-box, rgba(255, 255, 0, 0.8), 10, 0, 0, 0);
    -fx-cursor: hand;
}

/* 数字のオーバーレイ用スタイル */
.tile-number {
    -fx-text-fill: white;
    -fx-font-size: 14px;
    -fx-font-weight: bold;
    -fx-effect: dropshadow(one-pass-box, black, 2, 0, 1, 1);
    -fx-opacity: 0.7;
}
```

## 3. ロギング方針
デバッグおよび保守のため、適切なロギングを行います。

- **使用ライブラリ**: `java.util.logging` (標準)
- **ログレベル**:
    - `INFO`: ゲーム開始、画像読み込み成功、パズル完成などの主要イベント。
    - `WARNING`: サポート外の画像形式の読み込み試行、不適切な操作。
    - `SEVERE`: 予期せぬ実行時エラー、リソース読み込み失敗。

## 4. エラーハンドリング
- **ファイル IO**: 画像ファイルが存在しない、または読み取り権限がない場合の例外処理。
- **メモリ管理**: 高解像度の画像を大量に読み込んだ際のメモリ不足（OutOfMemoryError）への配慮（適切なリサイズと不要なオブジェクトの破棄）。
